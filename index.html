<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAA Authentication Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
      color: #333;
    }
    h1 { font-size: 20px; margin: 0 0 16px 0; }
    .card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .card h2 {
      font-size: 14px;
      color: #666;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
    }
    .indicator.success { background: #4caf50; }
    .indicator.error { background: #f44336; }
    .indicator.pending { background: #ff9800; }
    .indicator.loading {
      background: #2196f3;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    button {
      background: #6264a7;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 8px;
    }
    button:hover { background: #464775; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 4px;
      padding: 12px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log-entry { margin-bottom: 4px; }
    .log-entry.info { color: #569cd6; }
    .log-entry.success { color: #4ec9b0; }
    .log-entry.error { color: #f14c4c; }
    .log-entry.warn { color: #dcdcaa; }
    .env-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #eee;
    }
    .env-item:last-child { border-bottom: none; }
    .env-value {
      font-family: monospace;
      color: #666;
      font-size: 12px;
    }
    .token-preview {
      background: #f0f0f0;
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
      word-break: break-all;
      margin-top: 8px;
    }
    .config-input {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    .config-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <h1>NAA Authentication Test</h1>

  <!-- Configuration -->
  <div class="card">
    <h2>Configuration</h2>
    <div class="config-label">Azure AD Client ID:</div>
    <input type="text" id="clientId" class="config-input" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
    <div class="config-label">Azure AD Tenant ID:</div>
    <input type="text" id="tenantId" class="config-input" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
    <button id="saveBtn">Save Configuration</button>
  </div>

  <!-- Environment Detection -->
  <div class="card">
    <h2>Environment</h2>
    <div class="env-item">
      <span>User Agent</span>
      <span class="env-value" id="userAgent">-</span>
    </div>
    <div class="env-item">
      <span>Platform</span>
      <span class="env-value" id="platform">-</span>
    </div>
    <div class="env-item">
      <span>In iframe</span>
      <span class="env-value" id="inIframe">-</span>
    </div>
    <div class="env-item">
      <span>Teams Mobile</span>
      <span class="env-value" id="teamsMobile">-</span>
    </div>
  </div>

  <!-- Status -->
  <div class="card">
    <h2>Status</h2>
    <div class="status">
      <div class="indicator" id="teamsIndicator"></div>
      <span>Teams SDK Initialized</span>
    </div>
    <div class="status">
      <div class="indicator" id="naaIndicator"></div>
      <span>NAA Supported</span>
    </div>
    <div class="status">
      <div class="indicator" id="authIndicator"></div>
      <span>Authenticated</span>
    </div>
  </div>

  <!-- Actions -->
  <div class="card">
    <h2>Actions</h2>
    <button id="initBtn">1. Initialize Teams SDK</button>
    <button id="checkNaaBtn" disabled>2. Check NAA Support</button>
    <button id="authBtn" disabled>3. Authenticate with NAA</button>
    <button id="clearBtn">Clear Logs</button>
  </div>

  <!-- Token Result -->
  <div class="card" id="tokenCard" style="display: none;">
    <h2>Token Result</h2>
    <div id="tokenClaims"></div>
    <div class="token-preview" id="tokenPreview"></div>
  </div>

  <!-- Logs -->
  <div class="card">
    <h2>Logs</h2>
    <div class="log" id="logContainer"></div>
  </div>

  <!-- Teams SDK (non-module) -->
  <script src="https://res.cdn.office.net/teams-js/2.47.0/js/MicrosoftTeams.min.js"></script>

  <!-- Load MSAL v3 as ES module and expose to window -->
  <script type="module">
    import * as msal from 'https://cdn.jsdelivr.net/npm/@azure/msal-browser@3.27.0/+esm';
    window.msal = msal;
    console.log('MSAL v3 loaded:', Object.keys(msal));
    window.dispatchEvent(new Event('msalLoaded'));
  </script>

  <!-- Main app logic (waits for MSAL to load) -->
  <script>
    // Wait for MSAL module to load
    window.addEventListener('msalLoaded', function() {
      console.log('MSAL ready, initializing app...');
      initApp();
    });

    // Fallback if event already fired
    setTimeout(function() {
      if (window.msal) {
        console.log('MSAL detected via timeout');
        initApp();
      }
    }, 2000);

    let appInitialized = false;
    let teamsInitialized = false;
    let naaSupported = false;
    let msalInstance = null;

    function initApp() {
      if (appInitialized) return;
      appInitialized = true;

      // Load config
      const clientId = localStorage.getItem('naa_test_clientId') || '';
      const tenantId = localStorage.getItem('naa_test_tenantId') || '';
      document.getElementById('clientId').value = clientId;
      document.getElementById('tenantId').value = tenantId;

      // Detect environment
      detectEnvironment();

      // Setup button handlers
      document.getElementById('saveBtn').addEventListener('click', saveConfig);
      document.getElementById('initBtn').addEventListener('click', initializeTeams);
      document.getElementById('checkNaaBtn').addEventListener('click', checkNAASupport);
      document.getElementById('authBtn').addEventListener('click', authenticateWithNAA);
      document.getElementById('clearBtn').addEventListener('click', clearLogs);

      log('Ready. Click "Initialize Teams SDK" to start.');
      log('Make sure you are running this inside Microsoft Teams!', 'warn');
    }

    function saveConfig() {
      const clientId = document.getElementById('clientId').value.trim();
      const tenantId = document.getElementById('tenantId').value.trim();
      localStorage.setItem('naa_test_clientId', clientId);
      localStorage.setItem('naa_test_tenantId', tenantId);
      log('Config saved', 'success');
    }

    function getConfig() {
      return {
        clientId: document.getElementById('clientId').value.trim(),
        tenantId: document.getElementById('tenantId').value.trim()
      };
    }

    function log(message, type) {
      type = type || 'info';
      const container = document.getElementById('logContainer');
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      entry.textContent = '[' + timestamp + '] ' + message;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
      console.log('[' + type.toUpperCase() + ']', message);
    }

    function clearLogs() {
      document.getElementById('logContainer').innerHTML = '';
      log('Logs cleared', 'info');
    }

    function setIndicator(id, status) {
      const indicator = document.getElementById(id);
      indicator.className = 'indicator ' + status;
    }

    function detectEnvironment() {
      const ua = navigator.userAgent;
      document.getElementById('userAgent').textContent = ua.substring(0, 50) + '...';
      document.getElementById('platform').textContent = navigator.platform;
      document.getElementById('inIframe').textContent = (window !== window.parent) ? 'Yes' : 'No';

      const isTeamsMobile = /TeamsMobile-iOS|TeamsMobile-Android/.test(ua);
      document.getElementById('teamsMobile').textContent = isTeamsMobile ? 'Yes' : 'No';

      log('Platform: ' + navigator.platform);
      log('In iframe: ' + (window !== window.parent));
      log('Teams Mobile: ' + isTeamsMobile);

      if (isTeamsMobile) {
        log('iOS/Android Teams mobile detected!', 'warn');
      }
    }

    async function initializeTeams() {
      const btn = document.getElementById('initBtn');
      btn.disabled = true;
      setIndicator('teamsIndicator', 'loading');

      log('Initializing Teams SDK...');
      const startTime = Date.now();

      try {
        await microsoftTeams.app.initialize();
        const elapsed = Date.now() - startTime;

        teamsInitialized = true;
        setIndicator('teamsIndicator', 'success');
        log('Teams SDK initialized in ' + elapsed + 'ms', 'success');

        try {
          const context = await microsoftTeams.app.getContext();
          log('Teams context: ' + (context.app?.host?.clientType || 'unknown'));
          log('Tenant: ' + (context.user?.tenant?.id || 'N/A'));
          log('User: ' + (context.user?.userPrincipalName || 'N/A'));
        } catch (ctxErr) {
          log('Context error: ' + ctxErr.message, 'warn');
        }

        document.getElementById('checkNaaBtn').disabled = false;

      } catch (error) {
        setIndicator('teamsIndicator', 'error');
        log('Teams SDK failed: ' + error.message, 'error');
        log('Are you running this inside Microsoft Teams?', 'warn');
      }

      btn.disabled = false;
    }

    async function checkNAASupport() {
      const btn = document.getElementById('checkNaaBtn');
      btn.disabled = true;
      setIndicator('naaIndicator', 'loading');

      log('Checking NAA support...');

      try {
        if (microsoftTeams.nestedAppAuth && microsoftTeams.nestedAppAuth.isNAAChannelRecommended) {
          naaSupported = await microsoftTeams.nestedAppAuth.isNAAChannelRecommended();
          log('isNAAChannelRecommended: ' + naaSupported, naaSupported ? 'success' : 'warn');
        } else {
          log('nestedAppAuth API not available in this Teams version', 'warn');
          naaSupported = false;
        }

        if (naaSupported) {
          setIndicator('naaIndicator', 'success');
          log('NAA is supported! You can use NAA authentication.', 'success');
        } else {
          setIndicator('naaIndicator', 'error');
          log('NAA not recommended - will try anyway', 'warn');
        }

        document.getElementById('authBtn').disabled = false;

      } catch (error) {
        setIndicator('naaIndicator', 'error');
        log('NAA check failed: ' + error.message, 'error');
      }

      btn.disabled = false;
    }

    async function authenticateWithNAA() {
      const config = getConfig();

      if (!config.clientId || !config.tenantId) {
        log('Please enter Client ID and Tenant ID first!', 'error');
        return;
      }

      if (!window.msal) {
        log('MSAL not loaded yet! Wait a moment and try again.', 'error');
        return;
      }

      if (!window.msal.createNestablePublicClientApplication) {
        log('createNestablePublicClientApplication not found in MSAL!', 'error');
        log('Available MSAL exports: ' + Object.keys(window.msal).join(', '), 'warn');
        return;
      }

      const btn = document.getElementById('authBtn');
      btn.disabled = true;
      setIndicator('authIndicator', 'loading');

      log('Using Client ID: ' + config.clientId);
      log('Using Tenant ID: ' + config.tenantId);
      log('Creating NAA-enabled MSAL client...');

      try {
        msalInstance = await window.msal.createNestablePublicClientApplication({
          auth: {
            clientId: config.clientId,
            authority: 'https://login.microsoftonline.com/' + config.tenantId,
            supportsNestedAppAuth: true
          },
          cache: {
            cacheLocation: 'localStorage'
          }
        });

        log('NAA MSAL client created successfully', 'success');

        const accounts = msalInstance.getAllAccounts();
        log('Found ' + accounts.length + ' cached account(s)');

        let result = null;

        if (accounts.length > 0) {
          log('Attempting silent token acquisition...');
          try {
            result = await msalInstance.acquireTokenSilent({
              scopes: ['User.Read'],
              account: accounts[0]
            });
            log('Silent token acquisition successful!', 'success');
          } catch (silentErr) {
            log('Silent failed: ' + silentErr.message, 'warn');
            log('Will try interactive...', 'info');
          }
        }

        if (!result) {
          log('Attempting interactive (popup) authentication...');
          log('A popup or consent dialog should appear...', 'info');

          result = await msalInstance.acquireTokenPopup({
            scopes: ['User.Read']
          });

          log('Interactive authentication successful!', 'success');
        }

        setIndicator('authIndicator', 'success');
        showTokenResult(result);

      } catch (error) {
        setIndicator('authIndicator', 'error');
        log('Authentication failed: ' + error.name, 'error');
        log('Error message: ' + error.message, 'error');

        if (error.errorCode) {
          log('Error code: ' + error.errorCode, 'error');
        }

        if (error.message.includes('interaction_in_progress')) {
          log('Hint: Close any open auth popups and try again', 'warn');
        } else if (error.message.includes('redirect')) {
          log('Hint: Redirect auth not supported in iframe', 'warn');
        } else if (error.message.includes('popup')) {
          log('Hint: Popup may be blocked - check browser settings', 'warn');
        }
      }

      btn.disabled = false;
    }

    function showTokenResult(result) {
      const card = document.getElementById('tokenCard');
      card.style.display = 'block';

      try {
        const tokenParts = result.accessToken.split('.');
        const payload = JSON.parse(atob(tokenParts[1]));

        const claims = document.getElementById('tokenClaims');
        claims.innerHTML =
          '<div class="env-item"><span>Name</span><span class="env-value">' + (payload.name || 'N/A') + '</span></div>' +
          '<div class="env-item"><span>UPN</span><span class="env-value">' + (payload.upn || payload.preferred_username || 'N/A') + '</span></div>' +
          '<div class="env-item"><span>Tenant</span><span class="env-value">' + (payload.tid || 'N/A') + '</span></div>' +
          '<div class="env-item"><span>Audience</span><span class="env-value">' + (payload.aud || 'N/A') + '</span></div>' +
          '<div class="env-item"><span>Expires</span><span class="env-value">' + new Date(payload.exp * 1000).toLocaleString() + '</span></div>';

        document.getElementById('tokenPreview').textContent = result.accessToken.substring(0, 100) + '...';

        log('Token decoded successfully - check Token Result section', 'success');

      } catch (e) {
        log('Token decode error: ' + e.message, 'warn');
      }
    }
  </script>
</body>
</html>
